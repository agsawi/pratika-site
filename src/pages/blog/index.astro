---
import MainLayout from "@/layouts/MainLayout.astro";
import { createDirectus, readItems, rest, staticToken } from "@directus/sdk";
import { buildTitle } from "@/lib/seo";

function getClient() {
  const url = import.meta.env.DIRECTUS_URL as string | undefined;
  const token = import.meta.env.DIRECTUS_TOKEN as string | undefined;
  if (!url) return null;
  const base = token ? createDirectus(url).with(staticToken(token)) : createDirectus(url);
  return base.with(rest());
}

let posts: any[] = [];
const client = getClient();
if (client) {
  posts = await client.request(readItems('posts', {
    filter: { status: { _eq: 'published' } },
    sort: ['-published_at'],
    fields: ['title','slug','excerpt','published_at'],
    limit: 20
  })) as any[];
}
---
<MainLayout title={buildTitle('Blog')}>
  <section class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8">
    <h1 class="mb-6 text-3xl font-bold">Blog</h1>
    {posts.length === 0 ? (
      <p class="text-neutral-600 dark:text-neutral-300">No posts yet.</p>
    ) : (
      <ul class="space-y-4">
        {posts.map((p: any) => (
          <li class="rounded-lg border border-neutral-200 p-4 hover:bg-neutral-50 dark:border-neutral-800 dark:hover:bg-neutral-900">
            <a href={`/blog/${p.slug}`} class="text-lg font-semibold">{p.title}</a>
            {p.excerpt && <p class="mt-1 text-neutral-600 dark:text-neutral-300">{p.excerpt}</p>}
          </li>
        ))}
      </ul>
    )}
  </section>
</MainLayout>
